version: '3.8'

services:
  # ================== INFRAESTRUCTURA ==================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    container_name: saga-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: [ "CMD", "echo", "ruok", "|", "nc", "localhost", "2181" ]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    container_name: saga-kafka
    depends_on:
      - zookeeper
    ports:
      - "9094:9094"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://127.0.0.1:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    healthcheck:
      test: [ "CMD", "kafka-topics", "--bootstrap-server", "127.0.0.1:9094", "--list" ]
      interval: 10s
      timeout: 10s
      retries: 10

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: saga-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8300:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: saga-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
  # ================== BASES DE DATOS (Opcional: PostgreSQL) ==================
  # Descomenta si quieres usar PostgreSQL en lugar de H2
  # postgres-order:
  #   image: postgres:16-alpine
  #   container_name: saga-postgres-order
  #   environment:
  #     POSTGRES_DB: orderdb
  #     POSTGRES_USER: saga
  #     POSTGRES_PASSWORD: saga123
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-order-data:/var/lib/postgresql/data

  # postgres-payment:
  #   image: postgres:16-alpine
  #   container_name: saga-postgres-payment
  #   environment:
  #     POSTGRES_DB: paymentdb
  #     POSTGRES_USER: saga
  #     POSTGRES_PASSWORD: saga123
  #   ports:
  #     - "5433:5432"
  #   volumes:
  #     - postgres-payment-data:/var/lib/postgresql/data

  # postgres-inventory:
  #   image: postgres:16-alpine
  #   container_name: saga-postgres-inventory
  #   environment:
  #     POSTGRES_DB: inventorydb
  #     POSTGRES_USER: saga
  #     POSTGRES_PASSWORD: saga123
  #   ports:
  #     - "5434:5432"
  #   volumes:
  #     - postgres-inventory-data:/var/lib/postgresql/data

  # ================== MICROSERVICIOS (Opcional: Construir y ejecutar) ==================
  # Para desarrollo, es más práctico ejecutar los JAR localmente
  # y conectarlos a Kafka via localhost:9092.
  #
  # Si prefieres containerizar los microservicios, descomenta y ajusta:

  # order-service:
  #   build:
  #     context: ./order-service
  #     dockerfile: Dockerfile
  #   container_name: saga-order-service
  #   depends_on:
  #     kafka:
  #       condition: service_healthy
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092

  # payment-service:
  #   build:
  #     context: ./payment-service
  #     dockerfile: Dockerfile
  #   container_name: saga-payment-service
  #   depends_on:
  #     kafka:
  #       condition: service_healthy
  #   ports:
  #     - "8081:8081"
  #   environment:
  #     SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092

  # inventory-service:
  #   build:
  #     context: ./inventory-service
  #     dockerfile: Dockerfile
  #   container_name: saga-inventory-service
  #   depends_on:
  #     kafka:
  #       condition: service_healthy
  #   ports:
  #     - "8082:8082"
  #   environment:
  #     SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092

  # volumes:
  #   postgres-order-data:
  #   postgres-payment-data:
  #   postgres-inventory-data:
